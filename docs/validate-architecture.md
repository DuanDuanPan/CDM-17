---
title: Architecture Validation — 脑图驱动协同研发平台
date: 2025-12-12
owner: Enjoyjavapan
status: draft
scope: 校验架构对齐 PRD/UX/Epics（R1–R24）、性能/安全基线
---

## 快速结论
- 架构满足核心路径：脑图/多视图、任务依赖/审批、权限/水印/审计、通知节流、模板/AI、导出/分享、访问记录、自由布局。
- 需补强/待决：访问记录数据模型细节、分享默认策略（水印/遮罩/有效期）、导出范围与遮罩冲突提示、字段/附件继承策略、跨图血缘合并策略。
- 风险最高：大图性能（1k 节点、50 并发）、导出/审计可靠性、权限策略一致性（前后端）、分享漏配。

## 覆盖检查（对 PRD/UX/Epics）
- R1–R17：已在架构文档与 epics 覆盖。
- R18–R24 增强：
  - 自由布局（R18）：有 Layout Engine（前端+持久化）；需确认布局存储 schema 与回退策略。
  - 模板/片段（R19）：Template Service 具预置字段/密级；需定义模板版本与发布/回滚。
  - 协同可见性/评论节流（R20）：Realtime Hub+Notification 节流；需验证未读计数来源一致（收件箱 vs 评论面板）。
  - 导出遮罩（R21）：Export Service 支持水印/遮罩/范围；需定义遮罩策略优先级与失败降级。
  - 访问记录（R22）：Audit/Visit Log 定义，但需定 schema、索引、留存/脱敏规则。
  - 快速上手（R23）：Command & Paste Engine 定义；需确认粘贴解析器容错与回收策略。
  - 分享联动（R24）：Share & Link Manager 定义；需明确默认有效期和密级校验的拒绝提示。

## 性能与安全
- 性能路径：视口分片、关系线裁剪、增量协同、导出异步分片；满足 P95 目标的策略存在，但需压测脚本与观测指标落地。
- 安全：OPA/ACL + 水印/遮罩 + 审计；需补充“高密级资源禁止公共分享”硬约束。

## 风险与改进建议
1) 大图性能：补充压测脚本清单（加载/缩放/折叠/批量粘贴/导出），并将性能埋点纳入观测基线。
2) 导出/审计可靠性：为 Export Service 增加队列重试与分片校验；审计写入失败告警与重放。
3) 权限一致性：定义“前端遮罩优先级 < 后端 ACL”，并统一错误码与提示。
4) 访问记录：锁定 schema（事件、主体、资源、密级、IP、客户端、结果、时间），索引与留存策略；默认脱敏规则。
5) 分享策略：默认水印开、遮罩开、有效期（如 7 天），超密级阻断；失效操作实时。
6) 模板/片段版本：支持模板版本号与回滚，避免错误模板批量污染。
7) 评论/未读一致性：收件箱与评论面板共享同一未读源，防双重计数。

## 行动清单（短期）
- A1：补充访问记录数据模型/索引/留存到架构与未决项。
- A2：定义分享默认策略与拒绝提示，写入 PRD 未决/架构。
- A3：导出遮罩冲突提示文案与降级（分片失败→提示重试/分范围）。
- A4：模板版本与回滚方案；发布流程。
- A5：性能压测脚本与指标表，纳入测试设计。
