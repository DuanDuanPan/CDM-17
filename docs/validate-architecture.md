---
title: Architecture Validation — 脑图驱动协同研发平台
date: 2025-12-12
owner: Enjoyjavapan
status: ready
scope: 校验架构对齐 PRD/UX/Epics（R1–R24）、性能/安全基线；含 2025-12-12 决策闭环更新
---

## 快速结论
- 架构满足核心路径：脑图/多视图、任务依赖/审批、权限/水印/审计、通知节流、模板/AI、导出/分享、访问记录、自由布局。
- 已补强（2025-12-12）：访问记录数据模型/索引/留存脱敏；分享默认策略（强制水印遮罩、默认 7 天、机密及以上禁止公开）；导出范围与遮罩冲突降级；模板版本/回滚；压测脚本与指标；未读计数单一来源与错误码。
- 待跟进：字段/附件继承策略、跨图血缘粒度与冲突处理（不阻塞当前迭代）。
- 风险最高：大图性能（1k 节点、50 并发）、导出/审计可靠性、权限策略一致性（前后端）；均有脚本/监控计划，需执行验证。

## 覆盖检查（对 PRD/UX/Epics）
- R1–R17：已在架构文档与 epics 覆盖。
- R18–R24 增强：
  - 自由布局（R18）：Layout Engine（前端+持久化）；布局存储 schema 待在实现阶段细化。
  - 模板/片段（R19）：Template Service 具预置字段/密级；版本/发布/回滚流程已定义（draft→published→deprecated）。
  - 协同可见性/评论节流（R20）：Realtime Hub+Notification 节流；未读计数单一来源已确认（收件箱）。
  - 导出遮罩（R21）：Export Service 支持水印/遮罩/范围；遮罩节点>500 降级提示，分片/重试兜底。
  - 访问记录（R22）：Audit/Visit Log schema/索引/留存/脱敏已锁定（热 90 天、冷 12 个月、IP/UA 30 天哈希，强制 project_id+时间窗查询）。
  - 快速上手（R23）：Command & Paste Engine 定义；解析容错/回收在实现阶段校准。
  - 分享联动（R24）：默认水印+遮罩不可关；默认有效期 7 天（1–30 可调）；机密及以上禁用公开链接；拒绝提示与错误码约定。

## 性能与安全
- 性能路径：视口分片、关系线裁剪、增量协同、导出异步分片；压测脚本 Script-P1/P2/P3 与指标已定义，需执行并回填。
- 安全：OPA/ACL + 水印/遮罩 + 审计；新增“高密级资源禁止公共分享”“IP/UA 30 天后哈希”硬约束。

## 风险与改进建议
1) 大图性能：执行 Script-P1/P2 并回填观测；确保视口分片与关系线裁剪监控上线。
2) 导出/审计可靠性：Export 分片/重试与遮罩>500 降级提示实现；审计写入失败告警与重放。
3) 权限一致性：前端遮罩优先级 < 后端 ACL；错误码 40301/40302/40303/41001/42910 对齐前后端与文案。
4) 字段/附件继承策略、跨图血缘冲突处理：需在后续评审细化。

## 行动清单（短期）
- A1：补充访问记录数据模型/索引/留存到架构与未决项。
- A2：定义分享默认策略与拒绝提示，写入 PRD 未决/架构。
- A3：导出遮罩冲突提示文案与降级（分片失败→提示重试/分范围）。
- A4：模板版本与回滚方案；发布流程。
- A5：性能压测脚本与指标表，纳入测试设计。
